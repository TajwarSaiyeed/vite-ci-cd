# Name of the GitHub Actions workflow
name: Docker Image CI/CD

# Trigger conditions: when this workflow should run
on:
  # Run on every push to the main branch
  push:
    branches: ["main"]
  # Run on every pull request targeting the main branch
  pull_request:
    branches: ["main"]

# Define the jobs to be executed
jobs:
  # Job name: build-and-push
  build-and-push:
    # Run this job on the latest Ubuntu runner provided by GitHub
    runs-on: ubuntu-latest

    # Sequence of tasks to execute
    steps:
      # STEP 1: Checkout the repository code
      # This downloads my repository code into the GitHub Actions runner
      - name: Checkout code
        uses: actions/checkout@v4

      # STEP 2: Set up Docker Buildx
      # Buildx is an advanced Docker build tool that supports:
      # - Multi-platform builds
      # - Advanced caching
      # - Better build performance
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # STEP 3: Authenticate with Docker Hub
      # Uses secrets stored in GitHub repository settings
      # Required to push images to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          # GitHub secret containing my Docker Hub username
          username: ${{ secrets.DOCKER_USERNAME }}
          # GitHub secret containing my Docker Hub access token
          password: ${{ secrets.DOCKER_PASSWORD }}

      # STEP 4: Generate Docker image tags and labels
      # Creates standardized tags based on git branch, commit SHA, etc.
      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          # Image name format: <username>/vite-ci-cd
          images: ${{ secrets.DOCKER_USERNAME }}/vite-ci-cd
          # Tag generation rules:
          tags: |
            type=ref,event=branch          
            type=ref,event=pr              
            type=sha,prefix={{branch}}-    
            type=raw,value=latest,enable={{is_default_branch}}

      # STEP 5: Build the Docker image and push to Docker Hub
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          # Build context: current directory (repository root)
          context: .
          # Path to Dockerfile
          file: ./Dockerfile
          # Push to Docker Hub only if this is NOT a pull request
          push: ${{ github.event_name != 'pull_request' }}
          # Use the tags generated by the metadata step
          tags: ${{ steps.meta.outputs.tags }}
          # Use the labels generated by the metadata step
          labels: ${{ steps.meta.outputs.labels }}
          # Pass build arguments to Docker
          build-args: |
            VITE_API_URL=https://api.prod.example.com
          # Use GitHub Actions cache to speed up builds
          cache-from: type=gha
          # Save build cache for future builds
          # mode=max caches all layers (not just final image)
          cache-to: type=gha,mode=max
